---
layout: post
title: å…³äºäº‹ä»¶å¾ªç¯
date: 2025-08-15
updated: 2025-08-25
categories:
  - æŠ€æœ¯
tags:
  - äº‹ä»¶å¾ªç¯
---

### å‰è¨€

å…³äºè¿™ä¸ªäº‹ä»¶å¾ªç¯ï¼Œæœ€åˆåœ¨æ…§ç­–ç¬”è¯•çš„æ—¶å€™ç¢°åˆ°è¿‡ï¼Œç¾å›¢ä¸€é¢çš„æ—¶å€™ä¹Ÿè¢«æ‹·æ‰“è¿‡ï¼Œé¢è¯•å®˜å»ºè®®æˆ‘å†å¤šå»äº†è§£ä¸€ä¸‹ï¼Œæ‰€ä»¥å†™è¿™ç¯‡æ–‡ç« åŠ æ·±ä¸€ä¸‹å¯¹äº‹ä»¶å¾ªç¯çš„ç†è§£

### äº‹ä»¶å¾ªç¯æ¦‚å¿µ

äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰æ˜¯ JavaScript è¿è¡Œæ—¶çš„æ ¸å¿ƒæœºåˆ¶ï¼Œç”¨äºå¤„ç†å¼‚æ­¥æ“ä½œã€ç”¨æˆ·äº¤äº’ç­‰äº‹ä»¶ï¼Œä¿è¯ä»£ç æŒ‰é¡ºåºæ‰§è¡Œã€‚
JavaScript æ˜¯å•çº¿ç¨‹è¯­è¨€ï¼Œæ„å‘³ç€åŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚ä¸ºäº†å¤„ç†å¼‚æ­¥æ“ä½œï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€å®šæ—¶å™¨ç­‰ï¼‰ï¼Œ
JavaScript å¼•å…¥äº†äº‹ä»¶å¾ªç¯æœºåˆ¶ã€‚äº‹ä»¶å¾ªç¯è´Ÿè´£æ‰§è¡Œä»£ç ã€æ”¶é›†å’Œå¤„ç†äº‹ä»¶ä»¥åŠæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„å­ä»»åŠ¡ã€‚

### å·¥ä½œåŸç†
JavaScript è¿è¡Œæ—¶ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

- è°ƒç”¨æ ˆï¼ˆCall Stackï¼‰ï¼šç”¨äºæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œéµå¾ªåè¿›å…ˆå‡ºï¼ˆLIFOï¼‰åŸåˆ™ã€‚å½“å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œä¼šåœ¨è°ƒç”¨æ ˆä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆå¸§ï¼Œå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œæ ˆå¸§å‡ºæ ˆã€‚
- ä»»åŠ¡é˜Ÿåˆ—ï¼ˆTask Queueï¼‰ï¼šå­˜æ”¾å¼‚æ­¥æ“ä½œå®Œæˆåå¾…æ‰§è¡Œçš„å›è°ƒå‡½æ•°ã€‚ä»»åŠ¡é˜Ÿåˆ—åˆåˆ†ä¸ºå®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMacroTask Queueï¼‰å’Œå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMicroTask Queueï¼‰ã€‚
- äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰ï¼šæŒç»­æ£€æŸ¥è°ƒç”¨æ ˆæ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ºç©ºï¼Œåˆ™ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ”¾å…¥è°ƒç”¨æ ˆæ‰§è¡Œã€‚

äº‹ä»¶å¾ªç¯çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

- æ£€æŸ¥è°ƒç”¨æ ˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œæ‰§è¡Œè°ƒç”¨æ ˆä¸­çš„ä»»åŠ¡ã€‚
- è‹¥è°ƒç”¨æ ˆä¸ºç©ºï¼Œæ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦æœ‰ä»»åŠ¡ï¼Œè‹¥æœ‰åˆ™ä¾æ¬¡æ‰§è¡Œï¼Œç›´åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºã€‚
- å¾®ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©ºåï¼Œä»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªä»»åŠ¡æ”¾å…¥è°ƒç”¨æ ˆæ‰§è¡Œï¼Œæ‰§è¡Œå®Œæˆåï¼Œé‡å¤æ­¥éª¤ 2 å’Œ 3ã€‚

### å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡
 - å®ä»»åŠ¡ï¼ˆMacroTaskï¼‰ï¼šå¸¸è§çš„å®ä»»åŠ¡æœ‰ setTimeoutã€setIntervalã€setImmediateï¼ˆNode.jsï¼‰ã€requestAnimationFrameï¼ˆæµè§ˆå™¨ï¼‰ã€I/O æ“ä½œã€UI æ¸²æŸ“ç­‰ã€‚
 - å¾®ä»»åŠ¡ï¼ˆMicroTaskï¼‰ï¼šå¸¸è§çš„å¾®ä»»åŠ¡æœ‰ Promise.thenã€async/awaitï¼ˆæœ¬è´¨ä¸Šæ˜¯åŸºäº Promiseï¼‰ã€MutationObserverï¼ˆæµè§ˆå™¨ï¼‰ã€process.nextTickï¼ˆNode.jsï¼‰ç­‰ã€‚

### è¾“å‡ºä»£ç é¢˜ç»ƒä¹ 

æœ€ç®€å•çš„ï¼š

``` js
console.log('script start');

setTimeout(() => {
  console.log('setTimeout');
}, 0);

Promise.resolve()
  .then(() => {
    console.log('promise1');
  })
  .then(() => {
    console.log('promise2');
  });

console.log('script end');
```

::: details ç‚¹å‡»æŸ¥çœ‹è¾“å‡ºé¡ºåº
script start

script end

promise1

promise2

setTimeout
:::

æ‰§è¡Œè¿‡ç¨‹ï¼š
1. æ‰§è¡Œå…¨å±€ä»£ç ï¼Œå°† `console.log('script start')` å‹å…¥è°ƒç”¨æ ˆï¼Œæ‰§è¡Œå®Œæ¯•åå‡ºæ ˆã€‚
2. é‡åˆ° `setTimeout` å®šæ—¶å™¨ï¼Œå°†å…¶å›è°ƒå‡½æ•°å‹å…¥å®ä»»åŠ¡é˜Ÿåˆ—ã€‚
3. é‡åˆ° `Promise.resolve()`ï¼Œå°†å…¶å›è°ƒå‡½æ•°å‹å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚
4. æ‰§è¡Œ `console.log('script end')`ï¼Œå°†å…¶å‹å…¥è°ƒç”¨æ ˆï¼Œæ‰§è¡Œå®Œæ¯•åå‡ºæ ˆã€‚
5. è°ƒç”¨æ ˆä¸ºç©ºï¼Œæ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå‘ç°æœ‰ `Promise.then` å›è°ƒå‡½æ•°ï¼Œå°†å…¶å‹å…¥è°ƒç”¨æ ˆï¼Œæ‰§è¡Œå®Œæ¯•åå‡ºæ ˆã€‚
6. å†æ¬¡æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå‘ç°è¿˜æœ‰ `Promise.then` å›è°ƒå‡½æ•°ï¼Œå°†å…¶å‹å…¥è°ƒç”¨æ ˆï¼Œæ‰§è¡Œå®Œæ¯•åå‡ºæ ˆã€‚
7. å¾®ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©ºï¼Œä»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡º `setTimeout` å›è°ƒå‡½æ•°ï¼Œå°†å…¶å‹å…¥è°ƒç”¨æ ˆï¼Œæ‰§è¡Œå®Œæ¯•åå‡ºæ ˆã€‚
8. è°ƒç”¨æ ˆä¸ºç©ºï¼Œäº‹ä»¶å¾ªç¯ç»“æŸã€‚

``` js
async function async1() {
  console.log('async1 start');
  await new Promise(resolve => {
    console.log('promise1');
    setTimeout(() => {
      resolve();
      console.log('setTimeout1');
    }, 0);
  });
  console.log('async1 end');
}

async function async2() {
  console.log('async2 start');
  await new Promise(resolve => {
    setTimeout(() => {
      resolve();
      console.log('setTimeout2');
    }, 0);
  });
  console.log('async2 end');
}

console.log('script start');
async1();
async2();
new Promise(resolve => {
  console.log('promise2');
  resolve();
}).then(() => {
  console.log('promise3');
});
console.log('script end');
```
::: details ç‚¹å‡»æŸ¥çœ‹è¾“å‡ºé¡ºåº

script start

async1 start

promise1

async1 end

setTimeout1

async2 start

async2 end

setTimeout2

promise2

script end

promise3
:::

æ‰§è¡Œè¿‡ç¨‹ï¼š
1. æ‰§è¡Œå…¨å±€ä»£ç ï¼Œå°† `console.log('script start')` å‹å…¥è°ƒç”¨æ ˆï¼Œæ‰§è¡Œå®Œæ¯•åå‡ºæ ˆã€‚
2. é‡åˆ° `async1` å‡½æ•°ï¼Œå°†å…¶å‹å…¥è°ƒç”¨æ ˆï¼Œæ‰§è¡Œ async1 å‡½æ•°å†…éƒ¨ä»£ç ã€‚
3. æ‰§è¡Œ `console.log('async1 start')`ï¼Œå°†å…¶å‹å…¥è°ƒç”¨æ ˆï¼Œæ‰§è¡Œå®Œæ¯•åå‡ºæ ˆã€‚
4. é‡åˆ° `await` å…³é”®å­—ï¼Œå°† `await` åé¢çš„ `Promise` å‹å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå°† `async1` å‡½æ•°çš„å‰©ä½™ä»£ç å‹å…¥è°ƒç”¨æ ˆã€‚
5. æ‰§è¡Œ `console.log('promise1')`ï¼Œå°†å…¶å‹å…¥è°ƒç”¨æ ˆï¼Œæ‰§è¡Œå®Œæ¯•åå‡ºæ ˆã€‚
6. é‡åˆ° `setTimeout` å®šæ—¶å™¨ï¼Œå°†å…¶å›è°ƒå‡½æ•°å‹å…¥å®ä»»åŠ¡é˜Ÿåˆ—ã€‚
7. æ‰§è¡Œ `console.log('async1 end')`ï¼Œå°†å…¶å‹å…¥è°ƒç”¨æ ˆï¼Œæ‰§è¡Œå®Œæ¯•åå‡ºæ ˆã€‚
8. è°ƒç”¨æ ˆä¸ºç©ºï¼Œæ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå‘ç°æœ‰ `Promise.then` å›è°ƒå‡½æ•°ï¼Œå°†å…¶å‹å…¥è°ƒç”¨æ ˆï¼Œæ‰§è¡Œå®Œæ¯•åå‡ºæ ˆã€‚
9. å†æ¬¡æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸ºç©ºï¼Œä»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡º `setTimeout` å›è°ƒå‡½æ•°ï¼Œå°†å…¶å‹å…¥è°ƒç”¨æ ˆï¼Œæ‰§è¡Œå®Œæ¯•åå‡ºæ ˆã€‚
10. è°ƒç”¨æ ˆä¸ºç©ºï¼Œäº‹ä»¶å¾ªç¯ç»“æŸã€‚

å¦‚æœæ²¡æœ‰ `await` å…³é”®å­—çš„è¯ï¼Œè¾“å‡ºé¡ºåºå¦‚ä¸‹

::: details ç‚¹å‡»æŸ¥çœ‹è¾“å‡ºé¡ºåº
script start

async1 start

promise1

async1 end

async2 start

async2 end

promise2

script end

promise3

setTimeout1

setTimeout2
:::

**await çš„ä½œç”¨**ï¼š
ç”±äºawaitä¼šæš‚åœå½“å‰asyncå‡½æ•°ï¼Œå°†åç»­çš„ä»£ç åŒ…è£…æˆå¾®ä»»åŠ¡ï¼Œåªæœ‰å½“promiseæ”¹å˜çŠ¶æ€ï¼ˆpromiseå®Œæˆåï¼‰ï¼Œæ‰ä¼šæ¢å¤æ‰§è¡Œ

``` js
console.log("ğŸš€ å¼€å§‹");

Promise.resolve()
  .then(() => console.log("1ï¸âƒ£ ç¬¬ä¸€ä¸ª.then"))
  .then(() => console.log("2ï¸âƒ£ ç¬¬äºŒä¸ª.then"))

Promise.resolve().then(() => console.log("3ï¸âƒ£ å¤–éƒ¨.then"))
```

::: details ç‚¹å‡»æŸ¥çœ‹è¾“å‡ºé¡ºåº
``` text
ğŸš€ å¼€å§‹
1ï¸âƒ£ ç¬¬ä¸€ä¸ª.then
3ï¸âƒ£ å¤–éƒ¨.then
2ï¸âƒ£ ç¬¬äºŒä¸ª.then
```
:::

è¿™é¢˜æ˜¯æˆ‘ä¹‹å‰åšé”™çš„ï¼Œæˆ‘å½“æ—¶è¯¯ä»¥ä¸ºç¬¬äºŒä¸ªthenä¼šåœ¨å¤–éƒ¨thenä¹‹å‰æ‰§è¡Œï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯åœ¨å¤–éƒ¨thenä¹‹åæ‰§è¡Œçš„ã€‚æ­£ç¡®ç†è§£æ˜¯æ¯ä¸ª.thenåªæœ‰åœ¨å‰ä¸€ä¸ªPromiseè§£å†³åæ‰ä¼šæ³¨å†Œ

### ç›¸å…³èµ„æ–™

https://www.ruanyifeng.com/blog/2014/10/event-loop.html

https://segmentfault.com/a/1190000046362554

https://zhuanlan.zhihu.com/p/33058983

https://juejin.cn/post/6844904079353708557?searchId=20250815220628C3C5642C55BE65D2B440#heading-0
